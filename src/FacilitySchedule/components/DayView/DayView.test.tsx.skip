import { render, screen } from '@testing-library/react';
import { DayView, type DayViewProps } from './DayView';
import type { ScheduleEvent, Resource, FacilityScheduleSettings } from '../../FacilitySchedule.schema';

const mockResources: Resource[] = [
  {
    id: 'resource1',
    name: 'リソース1',
    order: 1,
    isAvailable: true,
    groupId: 'group1',
    createdAt: new Date(),
    updatedAt: new Date(),
  },
  {
    id: 'resource2',
    name: 'リソース2',
    order: 2,
    isAvailable: true,
    groupId: 'group1',
    createdAt: new Date(),
    updatedAt: new Date(),
  },
];

const mockEvents: ScheduleEvent[] = [
  {
    id: '1',
    groupId: 'group1',
    title: 'イベント1',
    attendee: '担当者1',
    startDate: new Date('2025-01-01T10:00:00'),
    endDate: new Date('2025-01-01T11:00:00'),
    status: 'confirmed',
    createdAt: new Date(),
    updatedAt: new Date(),
    resourceId: 'resource1',
    isAllDay: false,
  },
  {
    id: '2',
    groupId: 'group1',
    title: 'イベント2',
    attendee: '担当者2',
    startDate: new Date('2025-01-01T14:00:00'),
    endDate: new Date('2025-01-01T15:00:00'),
    status: 'confirmed',
    createdAt: new Date(),
    updatedAt: new Date(),
    resourceId: 'resource2',
    isAllDay: false,
  },
];

const mockSettings: FacilityScheduleSettings = {
  defaultDuration: 1,
  startTime: '08:00',
  endTime: '18:00',
  closedDays: [],
  weekStartsOn: 1,
  timeZone: 'Asia/Tokyo',
};

const defaultProps: DayViewProps = {
  currentDate: new Date('2025-01-01'),
  resources: mockResources,
  events: mockEvents,
  settings: mockSettings,
  onEventClick: vi.fn(),
  onEmptySlotClick: vi.fn(),
};

describe('DayView', () => {
  it('renders resource columns', () => {
    render(<DayView {...defaultProps} />);

    expect(screen.getByText('リソース1')).toBeInTheDocument();
    expect(screen.getByText('リソース2')).toBeInTheDocument();
  });

  it('renders time grid', () => {
    const { container } = render(<DayView {...defaultProps} />);

    const timeSlots = container.querySelectorAll('.text-xs');
    expect(timeSlots.length).toBeGreaterThan(0);
  });

  it('displays event count in resource header', () => {
    render(<DayView {...defaultProps} />);

    expect(screen.getByText('1 events')).toBeInTheDocument();
  });

  it('filters events for the current day', () => {
    const eventsForDifferentDay: ScheduleEvent[] = [
      ...mockEvents,
      {
        id: '3',
        groupId: 'group1',
        title: '別の日のイベント',
        attendee: '担当者3',
        startDate: new Date('2025-01-02T10:00:00'),
        endDate: new Date('2025-01-02T11:00:00'),
        status: 'confirmed',
        createdAt: new Date(),
        updatedAt: new Date(),
        resourceId: 'resource1',
        isAllDay: false,
      },
    ];

    render(
      <DayView
        {...defaultProps}
        events={eventsForDifferentDay}
      />
    );

    expect(screen.getByText('1 events')).toBeInTheDocument();
  });

  it('calls onEventClick when event is clicked', () => {
    const onEventClick = vi.fn();
    render(<DayView {...defaultProps} onEventClick={onEventClick} />);

    // This would require more specific querying
    // For now, we're just testing that the component renders
    expect(onEventClick).toBeDefined();
  });

  it('calculates correct grid height', () => {
    const { container } = render(<DayView {...defaultProps} />);

    const scrollableDiv = container.querySelector('.overflow-y-auto > div');
    expect(scrollableDiv).toBeInTheDocument();
  });
});
