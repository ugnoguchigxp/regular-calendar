import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { I18nextProvider } from 'react-i18next';
import { EventModal } from './EventModal';
import type { Resource, ResourceGroup, ScheduleEvent } from '../../FacilitySchedule.schema';
import type { Personnel } from '../../../PersonnelPanel/PersonnelPanel.schema';

const i18n = {
  resources: {},
  lng: 'en',
  fallbackLng: 'en',
  ns: ['common'],
  defaultNS: 'common',
  interpolation: {
    escapeValue: false,
  },
  react: {
    useSuspense: false,
  },
};

const mockResources: Resource[] = [
  {
    id: 'resource1',
    name: 'リソース1',
    order: 1,
    isAvailable: true,
    groupId: 'group1',
    createdAt: new Date(),
    updatedAt: new Date(),
  },
];

const mockGroups: ResourceGroup[] = [
  {
    id: 'group1',
    name: 'グループ1',
    displayMode: 'grid',
    dimension: 2,
    resources: mockResources,
    createdAt: new Date(),
    updatedAt: new Date(),
  },
];

const mockPersonnel: Personnel[] = [
  {
    id: '1',
    name: '田中 太郎',
    email: 'tanaka@example.com',
    department: '内科',
    priority: 1,
  },
];

const mockEvent: ScheduleEvent = {
  id: '1',
  groupId: 'group1',
  title: '会議',
  attendee: '田中 太郎',
  startDate: new Date('2025-01-01T10:00:00'),
  endDate: new Date('2025-01-01T11:00:00'),
  status: 'booked',
  createdAt: new Date(),
  updatedAt: new Date(),
  resourceId: 'resource1',
  isAllDay: false,
};

describe('EventModal', () => {
  it('renders modal when open', async () => {
    const onSave = vi.fn();
    const onClose = vi.fn();

    render(
      <EventModal
        isOpen={true}
        resources={mockResources}
        groups={mockGroups}
        events={[]}
        personnel={mockPersonnel}
        onClose={onClose}
        onSave={onSave}
      />
    );

    await waitFor(() => {
      expect(screen.getByText(/create/i)).toBeInTheDocument();
    });
  });

  it('renders edit mode when event is provided', async () => {
    const onSave = vi.fn();
    const onClose = vi.fn();

    render(
      <EventModal
        isOpen={true}
        event={mockEvent}
        resources={mockResources}
        groups={mockGroups}
        events={[]}
        personnel={mockPersonnel}
        onClose={onClose}
        onSave={onSave}
      />
    );

    await waitFor(() => {
      expect(screen.getByText(/edit/i)).toBeInTheDocument();
    });
  });

  it('does not render modal when closed', () => {
    const onSave = vi.fn();
    const onClose = vi.fn();

    render(
      <EventModal
        isOpen={false}
        resources={mockResources}
        groups={mockGroups}
        events={[]}
        personnel={mockPersonnel}
        onClose={onClose}
        onSave={onSave}
      />
    );

    expect(screen.queryByText(/create/i)).not.toBeInTheDocument();
  });

  it('calls onClose when cancel button is clicked', async () => {
    const user = userEvent.setup();
    const onSave = vi.fn();
    const onClose = vi.fn();

    render(
      <EventModal
        isOpen={true}
        resources={mockResources}
        groups={mockGroups}
        events={[]}
        personnel={mockPersonnel}
        onClose={onClose}
        onSave={onSave}
      />
    );

    await waitFor(() => {
      expect(screen.getByText(/cancel/i)).toBeInTheDocument();
    });

    await user.click(screen.getByText(/cancel/i));
    expect(onClose).toHaveBeenCalled();
  });

  it('shows delete button in edit mode', async () => {
    const onSave = vi.fn();
    const onClose = vi.fn();
    const onDelete = vi.fn();

    render(
      <EventModal
        isOpen={true}
        event={mockEvent}
        resources={mockResources}
        groups={mockGroups}
        events={[]}
        personnel={mockPersonnel}
        onClose={onClose}
        onSave={onSave}
        onDelete={onDelete}
      />
    );

    await waitFor(() => {
      expect(screen.getByText(/delete/i)).toBeInTheDocument();
    });
  });

  it('calls onDelete when delete is confirmed', async () => {
    const user = userEvent.setup();
    const onSave = vi.fn();
    const onClose = vi.fn();
    const onDelete = vi.fn();

    render(
      <EventModal
        isOpen={true}
        event={mockEvent}
        resources={mockResources}
        groups={mockGroups}
        events={[]}
        personnel={mockPersonnel}
        onClose={onClose}
        onSave={onSave}
        onDelete={onDelete}
      />
    );

    await waitFor(() => {
      expect(screen.getByText(/delete/i)).toBeInTheDocument();
    });

    await user.click(screen.getByText(/delete/i));
    await waitFor(() => {
      expect(screen.getByText(/confirm/i)).toBeInTheDocument();
    });

    const confirmButton = screen.getByText(/confirm/i);
    await user.click(confirmButton);

    expect(onDelete).toHaveBeenCalledWith('1');
  });
});
